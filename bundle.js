(()=>{"use strict";function t(t,e,s){return t+(e-t)*s}function e(e,s,i,n){const h=(n.x-i.x)*(e.y-i.y)-(n.y-i.y)*(e.x-i.x),a=(i.y-e.y)*(e.x-s.x)-(i.x-e.x)*(e.y-s.y),r=(n.y-i.y)*(s.x-e.x)-(n.x-i.x)*(s.y-e.y);if(0!=r){const i=h/r,n=a/r;if(i>=0&&i<=1&&n>=0&&n<=1)return{x:t(e.x,s.x,i),y:t(e.y,s.y,i),offset:i}}return null}function s(t,s){for(let i=0;i<t.length;i++)for(let n=0;n<s.length;n++)if(e(t[i],t[(i+1)%t.length],s[n],s[(n+1)%s.length]))return!0;return!1}function i(t){const e=t<0?0:255;return"rgba("+e+","+e+","+(t>0?0:255)+","+Math.abs(t)+")"}function n(){return"hsl("+(290+260*Math.random())+", 100%, 60%)"}class h{constructor(t){this.levels=[];for(let e=0;e<t.length-1;e++)this.levels.push(new a(t[e],t[e+1]))}static feedForward(t,e){let s=a.feedForward(t,e.levels[0]);for(let t=1;t<e.levels.length;t++)s=a.feedForward(s,e.levels[t]);return s}static crossover(t,e){const s=JSON.parse(JSON.stringify(t));for(let t=0;t<s.levels.length;t++){const i=s.levels[t],n=e.levels[t];for(let t=0;t<i.weights.length;t++)for(let e=0;e<i.weights[t].length;e++)Math.random()>.5&&(i.weights[t][e]=n.weights[t][e]);for(let t=0;t<i.biases.length;t++)Math.random()>.5&&(i.biases[t]=n.biases[t])}return s}static mutate(t,e=1){t.levels.forEach(t=>{for(let s=0;s<t.biases.length;s++)Math.random()<.1?t.biases[s]+=(2*Math.random()-1)*e*2:Math.random()<.3&&(t.biases[s]+=(2*Math.random()-1)*e*.5);for(let s=0;s<t.weights.length;s++)for(let i=0;i<t.weights[s].length;i++)Math.random()<.1?t.weights[s][i]+=(2*Math.random()-1)*e*2:Math.random()<.3&&(t.weights[s][i]+=(2*Math.random()-1)*e*.5)})}}class a{constructor(t,e){this.inputs=new Array(t),this.outputs=new Array(e),this.biases=new Array(e),this.weights=[];for(let s=0;s<t;s++)this.weights[s]=new Array(e);a.#t(this)}static#t(t){for(let e=0;e<t.inputs.length;e++)for(let s=0;s<t.outputs.length;s++)t.weights[e][s]=2*Math.random()-1;for(let e=0;e<t.biases.length;e++)t.biases[e]=2*Math.random()-1}static feedForward(t,e){for(let s=0;s<e.inputs.length;s++)e.inputs[s]=t[s];for(let t=0;t<e.outputs.length;t++){let s=0;for(let i=0;i<e.inputs.length;i++)s+=e.inputs[i]*e.weights[i][t];s>e.biases[t]?e.outputs[t]=1:e.outputs[t]=0}return e.outputs}}class r{constructor(t){this.car=t,this.rayCount=5,this.rayLength=150,this.raySpread=Math.PI/2,this.rays=[],this.readings=[]}update(t,e){this.#e(),this.readings=[];for(let s=0;s<this.rays.length;s++)this.readings.push(this.#s(this.rays[s],t,e))}#s(t,s,i){let n=[];for(let i=0;i<s.length;i++){const h=e(t[0],t[1],s[i][0],s[i][1]);h&&n.push(h)}for(let s=0;s<i.length;s++){const h=i[s].polygon;for(let s=0;s<h.length;s++){const i=e(t[0],t[1],h[s],h[(s+1)%h.length]);i&&n.push(i)}}if(0==n.length)return null;{const t=n.map(t=>t.offset),e=Math.min(...t);return n.find(t=>t.offset==e)}}#e(){this.rays=[];for(let e=0;e<this.rayCount;e++){const s=t(this.raySpread/2,-this.raySpread/2,1==this.rayCount?.5:e/(this.rayCount-1))+this.car.angle,i={x:this.car.x,y:this.car.y},n={x:this.car.x-Math.sin(s)*this.rayLength,y:this.car.y-Math.cos(s)*this.rayLength};this.rays.push([i,n])}}draw(t){for(let e=0;e<this.rayCount;e++){let s=this.rays[e][1];this.readings[e]&&(s=this.readings[e]),t.beginPath(),t.lineWidth=2,t.strokeStyle="yellow",t.moveTo(this.rays[e][0].x,this.rays[e][0].y),t.lineTo(s.x,s.y),t.stroke(),t.beginPath(),t.lineWidth=2,t.strokeStyle="black",t.moveTo(this.rays[e][1].x,this.rays[e][1].y),t.lineTo(s.x,s.y),t.stroke()}}}class o{constructor(t){switch(this.forward=!1,this.left=!1,this.right=!1,this.reverse=!1,t){case"KEYS":this.#i();break;case"DUMMY":this.forward=!0}}#i(){document.onkeydown=t=>{switch(t.key){case"a":this.left=!0;break;case"d":this.right=!0;break;case"w":this.forward=!0;break;case"s":this.reverse=!0}},document.onkeyup=t=>{switch(t.key){case"a":this.left=!1;break;case"d":this.right=!1;break;case"w":this.forward=!1;break;case"s":this.reverse=!1}}}}class l{constructor(t,e,s,i,n,a=3,l="blue"){this.x=t,this.y=e,this.width=s,this.height=i,this.speed=0,this.acceleration=.2,this.maxSpeed=a,this.friction=.05,this.angle=0,this.damaged=!1,this.useBrain="AI"==n,"DUMMY"!=n&&(this.sensor=new r(this),this.brain=new h([this.sensor.rayCount,6,4])),this.controls=new o(n),this.img=new Image,this.img.src="assets/car.png",this.mask=document.createElement("canvas"),this.mask.width=s,this.mask.height=i;const d=this.mask.getContext("2d");this.img.onload=()=>{d.fillStyle=l,d.rect(0,0,this.width,this.height),d.fill(),d.globalCompositeOperation="destination-atop",d.drawImage(this.img,0,0,this.width,this.height)}}update(t,e){if(this.damaged||(this.#n(),this.polygon=this.#h(),this.damaged=this.#a(t,e)),this.sensor){this.sensor.update(t,e);const s=this.sensor.readings.map(t=>null==t?0:1-t.offset),i=h.feedForward(s,this.brain);this.useBrain&&(this.controls.forward=i[0],this.controls.left=i[1],this.controls.right=i[2],this.controls.reverse=i[3])}}#a(t,e){for(let e=0;e<t.length;e++)if(s(this.polygon,t[e]))return!0;for(let t=0;t<e.length;t++)if(s(this.polygon,e[t].polygon))return!0;return!1}#h(){const t=[],e=Math.hypot(this.width,this.height)/2,s=Math.atan2(this.width,this.height);return t.push({x:this.x-Math.sin(this.angle-s)*e,y:this.y-Math.cos(this.angle-s)*e}),t.push({x:this.x-Math.sin(this.angle+s)*e,y:this.y-Math.cos(this.angle+s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle-s)*e,y:this.y-Math.cos(Math.PI+this.angle-s)*e}),t.push({x:this.x-Math.sin(Math.PI+this.angle+s)*e,y:this.y-Math.cos(Math.PI+this.angle+s)*e}),t}#n(){if(this.controls.forward&&(this.speed+=this.acceleration),this.controls.reverse&&(this.speed-=this.acceleration),this.speed>this.maxSpeed&&(this.speed=this.maxSpeed),this.speed<-this.maxSpeed/2&&(this.speed=-this.maxSpeed/2),this.speed>0&&(this.speed-=this.friction),this.speed<0&&(this.speed+=this.friction),Math.abs(this.speed)<this.friction&&(this.speed=0),0!=this.speed){const t=this.speed>0?1:-1;this.controls.left&&(this.angle+=.03*t),this.controls.right&&(this.angle-=.03*t)}this.x-=Math.sin(this.angle)*this.speed,this.y-=Math.cos(this.angle)*this.speed}draw(t,e=!1){this.sensor&&e&&this.sensor.draw(t),t.save(),t.translate(this.x,this.y),t.rotate(-this.angle),this.damaged||(t.drawImage(this.mask,-this.width/2,-this.height/2,this.width,this.height),t.globalCompositeOperation="multiply"),t.drawImage(this.img,-this.width/2,-this.height/2,this.width,this.height),t.restore()}}class d{static drawNetwork(e,s){const i=e.canvas.width-100,n=e.canvas.height-100,h=n/s.levels.length;for(let a=s.levels.length-1;a>=0;a--){const r=50+t(n-h,0,1==s.levels.length?.5:a/(s.levels.length-1));e.setLineDash([7,3]),d.drawLevel(e,s.levels[a],50,r,i,h,a==s.levels.length-1?["🠉","🠈","🠊","🠋"]:[])}}static drawLevel(t,e,s,n,h,a,r){const o=s+h,l=n+a,{inputs:g,outputs:c,weights:u,biases:f}=e;for(let e=0;e<g.length;e++)for(let h=0;h<c.length;h++)t.beginPath(),t.moveTo(d.#r(g,e,s,o),l),t.lineTo(d.#r(c,h,s,o),n),t.lineWidth=2,t.strokeStyle=i(u[e][h]),t.stroke();for(let e=0;e<g.length;e++){const n=d.#r(g,e,s,o);t.beginPath(),t.arc(n,l,18,0,2*Math.PI),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(n,l,.6*18,0,2*Math.PI),t.fillStyle=i(g[e]),t.fill()}for(let e=0;e<c.length;e++){const h=d.#r(c,e,s,o);t.beginPath(),t.arc(h,n,18,0,2*Math.PI),t.fillStyle="black",t.fill(),t.beginPath(),t.arc(h,n,.6*18,0,2*Math.PI),t.fillStyle=i(c[e]),t.fill(),t.beginPath(),t.lineWidth=2,t.arc(h,n,14.4,0,2*Math.PI),t.strokeStyle=i(f[e]),t.setLineDash([3,3]),t.stroke(),t.setLineDash([]),r[e]&&(t.beginPath(),t.textAlign="center",t.textBaseline="middle",t.fillStyle="black",t.strokeStyle="white",t.font="27px Arial",t.fillText(r[e],h,n+1.8),t.lineWidth=.5,t.strokeText(r[e],h,n+1.8))}}static#r(e,s,i,n){return t(i,n,1==e.length?.5:s/(e.length-1))}}let g=!1,c=1,u=1,f=0,y=0,m=0,w=0;function p(){const t=document.getElementById("speedSlider"),e=document.getElementById("speedValue");c=parseInt(t.value),e.textContent=c+"x"}const b=document.getElementById("carCanvas");b.width=200;const M=document.getElementById("networkCanvas");M.width=300,b.height=window.innerHeight,M.height=window.innerHeight;const x=b.getContext("2d"),v=M.getContext("2d"),k=new class{constructor(t,e,s=3){this.x=t,this.width=e,this.laneCount=s,this.left=t-e/2,this.right=t+e/2;this.top=-1e6,this.bottom=1e6;const i={x:this.left,y:this.top},n={x:this.right,y:this.top},h={x:this.left,y:this.bottom},a={x:this.right,y:this.bottom};this.borders=[[i,h],[n,a]]}getLaneCenter(t){const e=this.width/this.laneCount;return this.left+e/2+Math.min(t,this.laneCount-1)*e}draw(e){e.lineWidth=5,e.strokeStyle="white";for(let s=1;s<=this.laneCount-1;s++){const i=t(this.left,this.right,s/this.laneCount);e.setLineDash([20,20]),e.beginPath(),e.moveTo(i,this.top),e.lineTo(i,this.bottom),e.stroke()}e.setLineDash([]),this.borders.forEach(t=>{e.beginPath(),e.moveTo(t[0].x,t[0].y),e.lineTo(t[1].x,t[1].y),e.stroke()})}}(b.width/2,.9*b.width),C=function(){const t=[];for(let e=0;e<=100;e++)t.push(new l(k.getLaneCenter(1),100,30,50,"AI"));return t}();let I=C[0];if(localStorage.getItem("bestBrain"))for(let t=0;t<C.length;t++)C[t].brain=JSON.parse(localStorage.getItem("bestBrain")),0!=t&&h.mutate(C[t].brain,.1);const S=[new l(k.getLaneCenter(1),-100,30,50,"DUMMY",2,n()),new l(k.getLaneCenter(0),-300,30,50,"DUMMY",2,n()),new l(k.getLaneCenter(2),-300,30,50,"DUMMY",2,n()),new l(k.getLaneCenter(0),-500,30,50,"DUMMY",2,n()),new l(k.getLaneCenter(1),-500,30,50,"DUMMY",2,n()),new l(k.getLaneCenter(1),-700,30,50,"DUMMY",2,n()),new l(k.getLaneCenter(2),-700,30,50,"DUMMY",2,n())];function L(t){let e=-t.y;return e+=10*t.speed,t.damaged&&(e*=.5),Math.max(.1,e)}function B(t,e){let s=Math.random(),i=0;for(let n=0;n<t.length;n++)if(i+=e[n],s<=i)return t[n];return t[t.length-1]}function P(t){if(!g){0===y&&(y=t,m=t,w=0);for(let t=0;t<c;t++){for(let t=0;t<S.length;t++)S[t].update(k.borders,[]);for(let t=0;t<C.length;t++)C[t].update(k.borders,S)}if(I=C.find(t=>t.y==Math.min(...C.map(t=>t.y))),f=Math.min(f,I.y),I.y<w&&(w=I.y,m=t),function(){document.getElementById("generationCounter").textContent=u,document.getElementById("bestDistance").textContent=Math.round(f);const t=C.filter(t=>!t.damaged).length;if(document.getElementById("activeCars").textContent=t,C.length>0){const t=Math.max(...C.map(t=>L(t)));document.getElementById("bestFitness").textContent=Math.round(t)}const e=document.getElementById("progressIndicator");e&&(performance.now()-m>3e3?(e.textContent="Stuck!",e.style.color="red"):(e.textContent="Making progress",e.style.color="green"))}(),0===C.filter(t=>!t.damaged).length||t-y>2e4||t-m>5e3){const t=C.map(t=>L(t)),e=t.reduce((t,e)=>t+e,0),s=t.map(t=>t/e);for(let t=0;t<C.length;t++){if(C[t].y=100,C[t].damaged=!1,C[t].speed=0,C[t].angle=0,0===t){C[t].brain=JSON.parse(JSON.stringify(I.brain));continue}const e=B(C,s);let i=B(C,s),n=0;for(;i===e&&n<10&&C.length>1;)i=B(C,s),n++;e&&i?(C[t].brain=h.crossover(e.brain,i.brain),h.mutate(C[t].brain,.1)):(C[t].brain=JSON.parse(JSON.stringify(I.brain)),h.mutate(C[t].brain,.2))}u++,f=0,y=0}}b.height=window.innerHeight-20,M.height=window.innerHeight-20,x.save(),x.translate(0,-I.y+.7*b.height),k.draw(x);for(let t=0;t<S.length;t++)S[t].draw(x,"red");x.globalAlpha=.2;for(let t=0;t<C.length;t++)C[t].draw(x,"blue");x.globalAlpha=1,I.draw(x,"blue",!0),x.restore(),v.lineDashOffset=-t/50,d.drawNetwork(v,I.brain),(!g||c>1)&&requestAnimationFrame(P)}P(),window.addEventListener("resize",()=>{b.height=window.innerHeight,M.height=window.innerHeight,b.width=200,M.width=300}),document.getElementById("saveButton").addEventListener("click",function(){localStorage.setItem("bestBrain",JSON.stringify(I.brain))}),document.getElementById("discardButton").addEventListener("click",function(){localStorage.removeItem("bestBrain")}),document.getElementById("pauseButton").addEventListener("click",function(){g=!g,document.getElementById("pauseButton").textContent=g?"▶️ Resume":"⏸️ Pause",g||P()}),document.getElementById("speedSlider").addEventListener("input",p),p()})();